# 浏览器渲染

>[从 8 道面试题看浏览器渲染过程与性能优化](https://juejin.im/post/5e143104e51d45414a4715f7)
>
>[从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理](https://segmentfault.com/a/1190000012925872)
>
>[前22年的Loser，后4年和自己赛跑的人 | 最惨前端面经](https://juejin.im/post/5ecc0cbef265da770274b2a5)

## 从“在浏览器输入域名”到“页面静态资源完全加载”的整个流程

1. 用户输入

    当用户输入关键字并键入回车之后，这意味着当前页面即将要被替换成新的页面，不过在这个流程继续之前，浏览器还给了当前页面一次执行 `beforeunload` 事件的机会，`beforeunload` 事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面。

2. URL 请求过程

    首先，网络进程会查找本地缓存是否缓存了该资源。

    如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程。这请求前的第一步是要进行 `DNS` 解析，以获取请求域名的服务器 `IP` 地址。如果请求协议是 `HTTPS`，那么还需要建立 `TLS` 连接。

    + 其中，`DNS`也有几步缓存：浏览器缓存，`hosts`文件，
    + 如果本地域名解析服务器也没有该域名的记录，则开始递归+迭代解析
    + `TCP`三次握手，`HTTP`。`TLS`握手，`HTTPS`。

    接下来就是利用 `IP` 地址和服务器建立 `TCP` 连接。连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 `Cookie` 等数据附加到请求头中，然后向服务器发送构建的请求信息。

    数据在进入服务端之前，可能还会先经过负责负载均衡的服务器，它的作用就是将请求合理的分发到多台服务器上，这时假设服务端会响应一个 `HTML` 文件。

    首先浏览器会判断状态码是什么，如果是 `200` 那就继续解析，如果 `400` 或 `500` 的话就会报错，如果 `300` 的话会进行重定向，这里会有个重定向计数器，避免过多次的重定向，超过次数也会报错。
  
    浏览器开始解析文件，如果是 `gzip` 格式的话会先解压一下，然后通过文件的编码格式知道该如何去解码文件。

3. 准备渲染进程

    默认情况下，`Chrome` 会为每个页面分配一个渲染进程，也就是说，每打开一个新页面就会配套创建一个新的渲染进程。

4. 渲染阶段

    文件解码成功后会正式开始渲染流程，先会根据 `HTML` 构建 `DOM` 树，有`CSS`的话会去构建 `CSSOM` 树。如果遇到 `script` 标签的话，会判断是否存在 `async` 或者 `defer` ，前者会并行进行下载并执行 `JS`，后者会先下载文件，然后等待 `HTML` 解析完成后顺序执行。

    如果以上都没有，就会阻塞住渲染流程直到 `JS` 执行完毕。

    `CSSOM` 树和 `DOM` 树构建完成后会开始生成 `Render` 树，这一步就是确定页面元素的布局、样式等等诸多方面的东西

    在生成 `Render` 树的过程中，浏览器就开始调用 `GPU` 绘制，合成图层，将内容显示在屏幕上了。
