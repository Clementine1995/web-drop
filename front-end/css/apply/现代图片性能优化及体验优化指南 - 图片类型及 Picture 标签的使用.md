# 现代图片性能优化及体验优化指南 - 图片类型及 Picture 标签的使用

> 原文[现代图片性能优化及体验优化指南 - 图片类型及 Picture 标签的使用](https://www.cnblogs.com/coco1s/p/17107807.html)
>
> 参考[图像文件类型与格式指南](https://developer.mozilla.org/zh-CN/docs/Web/Media/Formats/Image_types)

图片资源，在业务中可谓是占据了非常大头的一环，尤其是其对带宽的消耗是十分巨大的。

对图片的性能优化及体验优化在今天就显得尤为重要。本文就将从各个方面阐述，在各种新特性满头飞的今天，可以如何尽可能的对图片资源，进行性能优化及体验优化。

## 图片类型的选取及 Picture 标签的使用

首先，从图片的类型上而言，除了常见的 PNG-8/PNG-24，JPEG，GIF 之外，更多的关注另外几个较新的图片格式：

- WebP
- JPEG XL
- AVIF

首先，通过一张表格，快速过一下这几个图片，将从图片类型、透明通道、动画、编解码性能、压缩算法、颜色支持、内存占用、兼容性方面，对比它们：

|图片类型|Alpha 通道|动画|编解码性能|压缩算法|颜色支持|内存占用|兼容性|
|-|-|-|-|-|-|-|-|
|GIF|支持|支持|较高|无损压缩|索引色(256)|基本一致|ALL|
|PNG-8/PNG-24|支持|不支持|较高|无损压缩|索引色(256)\直接色|基本一致|ALL|
|JPEG|不支持|不支持|较高|有损压缩|直接色|基本一致|ALL|
|WebP|支持|支持|编解码性能差（低配设备更为显著）|有损压缩\无损压缩|直接色|基本一致|高版本 Chrome\Opera\Android|
|JPEG XL|支持|支持|渐进式解码|有损压缩\无损压缩|直接色|基本一致|部分高版本 Chrome\Opera\Firefox\Edge|
|AVIF|支持|支持|编解码性能一般|有损压缩\无损压缩|直接色|基本一致|高版本 Chrome\Opera\Android\Edge|

首先，了解了解上述的一些参数含义：

- Alpha 通道：图片是否支持透明的特性

> 当然，需要指出的是，Alpha 没有透明度的意思，不代表透明度。opacity 和 transparency 才和透明度有关，前者是不透明度，后者是透明度。比如 css 中的「opacity: 0.5」就是设定元素有 50% 的不透明度。后来 Alvy Ray Smith 提出每个像素再增加一个 Alpha 通道，取值为0到1，用来储存这个像素是否对图片有「贡献」，0代表透明、1代表不透明。也就是说，「Alpha 通道」储存一个值，其外在表现是「透明度」，Alpha 和透明度没啥关系

- 动画：很好理解，图片是否支持多帧率动态图片，类似于 GIF

- 编解码性能：图像的解码与编码。这个很关键，很多人对待图片容易忽视图片的编解码性能，解码图像主要从图像文件中读出图像数据，而编码则是将图像数据写入图像文件。解码与编码的过程正好相反。而这两者的性能耗时会影响我们页面的的展示性能。

- 压缩算法：该图片格式是否支持压缩，支持的话，图片的压缩又会分为无损压缩与有损压缩

> 有损压缩算法是一种数据压缩方法，经过此方法压缩、解压的数据会与原始数据不同但是非常接近。原理是借由将次要的信息数据舍弃，牺牲一些质量来减少数据量、提高压缩比
>
> 无损压缩指数据经过压缩后，信息不受损失，还能完全恢复到压缩前的原样。无损压缩通常用于严格要求“经过压缩、解压缩的数据必须与原始数据一致”的场合。

- 颜色支持：会分为索引色与直接色，在过去，为了节省存储空间，并非所有图片都能支持所有颜色值，因此存在索引色这种优化方式。

> 索引颜色是一种以有限的方式管理数字图像颜色的技术，以节省计算机内存和文件存储，同时加速显示刷新和文件传输。即用一个数字来代表（索引）一种颜色，在存储图片的时候，存储一个数字的组合，同时存储数字到图片颜色的映射。这种方式只能存储有限种颜色。索引色常见有1位（即黑白），8位（即灰阶/256色），16位（即高彩），24位（即真彩），30/36/48位（即全彩）。
>
> 直接色使用四个数字来代表一种颜色，这四个数字分别代表这个颜色中红色、绿色、蓝色以及透明度（即 RGBA）。现在流行的显示设备可以在这四个维度分别支持256种变化，所以直接色可以表示2的32次方种颜色。

- 内存占用：图片对内存资源的占用

- 兼容性：影响图片格式能否大规模推广的核心要素之一

### WebP vs JPEG XL vs AVIF: JPEG 替代之战

因为传统的 PNG-8/PNG-24，JPEG，GIF 各自或多或少都存在一些问题，近些年来它们的替代方案之争也愈演愈烈，核心领跑者可能是 WebP、JPEG XL、AVIF。

再简单了解了解它们：

#### WebP

WebP 最初由 Google 在 2010 年 9 月发布，其特性总结如下：

1. 可以同时提供无损/有损压缩（像 JPEG 一样）和支持透明度（像 PNG 一样）的图片文件格式
2. 支持动画效果（像 GIF 一样）
3. WebP 主要优势在于有损编码，其无损编码的性能和压缩比表现一般
4. WebP 的缺点在于其编解码性能不是特别理想
5. 在兼容性方面，除了 IE，基本已经得到了全系列浏览器支持
6. 对于复杂的图像（比如照片）来说，WebP 无损编码表现并不好，但有损编码表现却非常棒。相近质量的图片解码速度 WebP 相距 JPEG 也已经相差不大了，而文件压缩比却能提升不少。

下图是一个测试对比：

![img1](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49dd1c0af7894e58abb9ac15421dcbd0~tplv-k3u1fbpfcp-watermark.image?)

加载同样张数的 JPEG 与 WebP 的耗时对比：

![img2](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/acaa234efbe349c3b3f132b67a22bac8~tplv-k3u1fbpfcp-watermark.image?)

对于 WebP 图片格式，简单做个总结：

1. 目前 WebP 与 JPEG 相比较，据资料考证，编码速度慢 10 倍，解码速度慢 1.5 倍
2. WebP 虽然会增加额外的解码时间，但由于大幅减少了文件体积，缩短了加载的时间，大页面图片量较多的场景下，页面的渲染速度是有较大加快的
3. 目前而言，是 WebP、JPEG XL、AVIF 三者中兼容性最好的

截止至（2023-02-05）的兼容性图：

![img3](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f64f92af8ef34192bd4accc225767c0e~tplv-k3u1fbpfcp-watermark.image?)

#### JPEG XL

JPEG XL 由联合图像专家组（开发原始 JPEG 标准的同一组织）于 2021 年发布，旨在成为传统 JPEG 的长期替代品。作为一种免版税的开源标准，JPEG XL 的创建者希望其格式的开放性能够吸引网络开发人员采用该标准，该格式的扩展名为 .jxl，JXL 核心比特流于 2021 年 1 月冻结，文件格式于 2021 年 4 月定稿。

> JPEG XL 中的 X 指 2000 年以来的多个 JPEG 标准的名称：JPEG XT、JPEG XR、JPEG XS，而 L 表示 'long-term'，表示“长期”。创建这种格式是为替换旧的JPEG文件格式，并使用足够长的时间。

其主要特点有：

- 与传统图像格式（例如JPEG、GIF和PNG）相比，有着更佳的效率与更丰富的功能
全面支持广色域和 HDR，支持 Alpha 通道，支持多帧（也就是动画支持）
有损压缩时：相同的视觉质量，比 JPEG 小约 60％。
无损压缩时：比 PNG 减小约 35％（对于 HDR，减小 50％）。
支持无损 JPEG 转码，减小约 20％ 文件大小。
渐进式解码，专为支持不同显示分辨率的响应式加载
开源免费：具有使用三条款版BSD许可证的开源参考实现的免版税格式
